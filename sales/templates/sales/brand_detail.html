{% extends 'sales/base.html' %}
{% load sales_filters %}

{% block title %}{{ brand.name_kr }} {{ month }}월{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">{{ brand.name_kr }} - {{ year }}년 {{ month }}월</h4>
        <small class="text-muted">브랜드별 일별 매출 상세</small>
    </div>
    <div class="d-flex gap-2">
        {% for m in months %}
        <a href="{% url 'sales:brand_detail' brand.code m.year m.month %}" class="btn btn-sm {% if m.month == month %}btn-primary{% else %}btn-outline-secondary{% endif %}">{{ m.month }}월</a>
        {% endfor %}
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="stat-card text-center">
            <div class="label">전체 GSV</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_gsv|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card text-center">
            <div class="label">B2C 합계</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_b2c|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card text-center">
            <div class="label">B2B 합계</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_b2b|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card text-center">
            <div class="label">환불 합계</div>
            <div class="value text-loss" style="font-size:1.1rem">{{ totals.total_refund|krw }}</div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">일별 GSV 추이</div>
    <div class="card-body">
        <canvas id="brandChart" height="280"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header">일별 상세</div>
    <div class="card-body p-0" style="overflow-x:auto">
        <table class="table table-sm table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th>날짜</th>
                    <th class="text-end">B2C 쇼피파이</th>
                    <th class="text-end">B2C 아마존</th>
                    <th class="text-end">B2C 틱톡</th>
                    <th class="text-end">B2C 합계</th>
                    <th class="text-end">환불</th>
                    <th class="text-end">GSV</th>
                    <th class="text-end">B2B</th>
                    <th class="text-end">전체 GSV</th>
                    <th class="text-end">쇼피파이 광고</th>
                </tr>
            </thead>
            <tbody>
            {% for d in daily %}
                <tr>
                    <td>{{ d.date|date:"m/d" }}</td>
                    <td class="text-end">{{ d.b2c_shopify|num }}</td>
                    <td class="text-end">{{ d.b2c_amazon|num }}</td>
                    <td class="text-end">{{ d.b2c_tiktok|num }}</td>
                    <td class="text-end"><strong>{{ d.b2c_total|num }}</strong></td>
                    <td class="text-end text-loss">{{ d.refund_total|num }}</td>
                    <td class="text-end">{{ d.gsv|num }}</td>
                    <td class="text-end">{{ d.b2b_total|num }}</td>
                    <td class="text-end"><strong>{{ d.total_gsv|num }}</strong></td>
                    <td class="text-end">{{ d.ad_shopify|num }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const labels = [{% for d in daily %}'{{ d.date|date:"m/d" }}',{% endfor %}];
const gsvData = [{% for d in daily %}{{ d.total_gsv|default:"0" }},{% endfor %}];
const b2cData = [{% for d in daily %}{{ d.b2c_total|default:"0" }},{% endfor %}];

new Chart(document.getElementById('brandChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [
            { label: '전체 GSV', data: gsvData, backgroundColor: 'rgba(37,99,235,0.7)', borderRadius: 3 },
            { label: 'B2C', data: b2cData, backgroundColor: 'rgba(124,58,237,0.4)', borderRadius: 3 },
        ]
    },
    options: {
        responsive: true, maintainAspectRatio: false,
        scales: { y: { ticks: { callback: v => '₩' + (v/1000000).toFixed(1) + 'M' } } }
    }
});
</script>
{% endblock %}
