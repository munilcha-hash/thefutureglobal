{% extends 'sales/base.html' %}
{% load sales_filters %}

{% block title %}대시보드 - 미국사업팀{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">대시보드</h4>
        <small class="text-muted">{{ selected_year }}년 {% if selected_month %}{{ selected_month }}월{% else %}전체{% endif %} 매출/손익 현황</small>
    </div>
    <div class="d-flex gap-2">
        <select class="form-select form-select-sm" style="width:auto" onchange="location.href='?year={{ selected_year }}&month='+this.value">
            <option value="0" {% if not selected_month %}selected{% endif %}>전체</option>
            {% for m in months %}
            <option value="{{ m.month }}" {% if selected_month == m.month %}selected{% endif %}>{{ m.month }}월</option>
            {% endfor %}
        </select>
        {% if exchange_rate %}
        <span class="badge bg-light text-dark border align-self-center">환율: ₩{{ exchange_rate.rate|num }}</span>
        {% endif %}
    </div>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label">GSV (순매출)</div>
            <div class="value">{{ totals.total_gsv|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label">매출원가</div>
            <div class="value">{{ totals.total_cogs|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label">총 비용</div>
            <div class="value">{{ totals.total_expense|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label">영업이익</div>
            <div class="value {% if totals.total_profit > 0 %}text-profit{% else %}text-loss{% endif %}">
                {{ totals.total_profit|krw }}
            </div>
            <div class="change {% if totals.avg_margin > 0 %}positive{% else %}negative{% endif %}">
                마진율 {{ totals.avg_margin|pct }}
            </div>
        </div>
    </div>
</div>

<!-- 비용 상세 -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label"><i class="bi bi-megaphone"></i> 퍼포먼스 광고</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_ad|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label"><i class="bi bi-person-video3"></i> 인플루언서 광고</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_influencer|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label"><i class="bi bi-percent"></i> 판매수수료</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_commission|krw }}</div>
        </div>
    </div>
    <div class="col-md-3 col-6">
        <div class="stat-card">
            <div class="label"><i class="bi bi-truck"></i> 운반비</div>
            <div class="value" style="font-size:1.1rem">{{ totals.total_shipping|krw }}</div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <!-- 일별 GSV 차트 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span>{% if selected_month %}일별{% else %}월별{% endif %} 매출 & 영업이익</span>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- 채널별 비중 -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">채널별 매출 비중</div>
            <div class="card-body">
                <canvas id="channelChart" height="280"></canvas>
                <div class="mt-3">
                    <small class="d-block"><span class="badge bg-primary">쇼피파이</span> {{ channel_totals.shopify|krw }}</small>
                    <small class="d-block mt-1"><span class="badge bg-warning text-dark">아마존</span> {{ channel_totals.amazon|krw }}</small>
                    <small class="d-block mt-1"><span class="badge bg-dark">틱톡샵</span> {{ channel_totals.tiktok|krw }}</small>
                    <small class="d-block mt-1 text-danger">환불: {{ channel_totals.refund|krw }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 브랜드별 -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">브랜드별 GSV</div>
            <div class="card-body">
                <canvas id="brandChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">브랜드별 매출 상세</div>
            <div class="card-body p-0">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr><th>브랜드</th><th class="text-end">GSV</th><th class="text-end">B2C</th><th class="text-end">B2B</th></tr>
                    </thead>
                    <tbody>
                    {% for b in brand_totals %}
                        <tr>
                            <td><strong>{{ b.brand__name_kr }}</strong></td>
                            <td class="text-end">{{ b.total_gsv|krw }}</td>
                            <td class="text-end">{{ b.total_b2c|krw }}</td>
                            <td class="text-end">{{ b.total_b2b|krw }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="text-center text-muted py-3">데이터 없음</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const year = {{ selected_year }};
    const month = {{ selected_month }};

    fetch(`/api/dashboard-data/?year=${year}&month=${month}`)
    .then(r => r.json())
    .then(data => {
        // Revenue Chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        let labels, gsvData, profitData;

        if (month > 0 && data.daily.length > 0) {
            labels = data.daily.map(d => d.date.slice(5));
            gsvData = data.daily.map(d => d.gsv);
            profitData = data.daily.map(d => d.profit);
        } else {
            labels = data.monthly.map(d => d.month + '월');
            gsvData = data.monthly.map(d => d.gsv);
            profitData = data.monthly.map(d => d.profit);
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'GSV',
                        data: gsvData,
                        backgroundColor: 'rgba(37,99,235,0.7)',
                        borderRadius: 4,
                        order: 2,
                    },
                    {
                        label: '영업이익',
                        data: profitData,
                        type: 'line',
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22,163,74,0.1)',
                        fill: true,
                        tension: 0.3,
                        order: 1,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { ticks: { callback: v => '₩' + (v/1000000).toFixed(0) + 'M' } }
                }
            }
        });
    });

    // Channel Chart
    const channelData = {
        shopify: {{ channel_totals.shopify|default:"0" }},
        amazon: {{ channel_totals.amazon|default:"0" }},
        tiktok: {{ channel_totals.tiktok|default:"0" }},
    };
    new Chart(document.getElementById('channelChart'), {
        type: 'doughnut',
        data: {
            labels: ['쇼피파이', '아마존', '틱톡샵'],
            datasets: [{
                data: [channelData.shopify, channelData.amazon, channelData.tiktok],
                backgroundColor: ['#2563eb', '#f59e0b', '#1e293b'],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            cutout: '60%',
        }
    });

    // Brand Chart
    const brandLabels = [{% for b in brand_totals %}'{{ b.brand__name_kr }}',{% endfor %}];
    const brandGSV = [{% for b in brand_totals %}{{ b.total_gsv|default:"0" }},{% endfor %}];
    if (brandLabels.length > 0) {
        new Chart(document.getElementById('brandChart'), {
            type: 'bar',
            data: {
                labels: brandLabels,
                datasets: [{
                    label: 'GSV',
                    data: brandGSV,
                    backgroundColor: ['#2563eb', '#7c3aed', '#f59e0b', '#16a34a'],
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { ticks: { callback: v => '₩' + (v/1000000).toFixed(0) + 'M' } } }
            }
        });
    }
});
</script>
{% endblock %}
