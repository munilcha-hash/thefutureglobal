{% extends 'sales/base.html' %}

{% block title %}데이터 업로드 - The Future Global{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="page-header text-center">
            <h3>Data Upload</h3>
            <div class="subtitle">지역별 엑셀 파일을 업로드하여 데이터를 임포트합니다</div>
        </div>

        <!-- 결과 메시지 영역 -->
        <div id="result-area" style="display:none;margin-bottom:1rem;"></div>

        <div class="card">
            <div class="card-body" style="padding:2rem;">
                <div style="text-align:center;margin-bottom:2rem;">
                    <div style="width:64px;height:64px;background:rgba(99,102,241,0.1);border-radius:16px;display:inline-flex;align-items:center;justify-content:center;margin-bottom:1rem;">
                        <i class="bi bi-cloud-arrow-up-fill" style="font-size:1.8rem;color:var(--accent-blue);"></i>
                    </div>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin:0;">
                        지역을 선택하고 해당 매출/손익 관리 엑셀 파일(.xlsx)을<br>업로드하면 자동으로 데이터가 임포트됩니다.
                    </p>
                </div>

                <div id="upload-form">
                    <div class="mb-3">
                        <label for="region" class="form-label" style="font-weight:600;font-size:0.85rem;">지역 선택</label>
                        <select class="form-select" id="region" onchange="updateGuide(this.value)">
                            {% for code, name in all_regions %}
                            <option value="{{ code }}" {% if current_region == code %}selected{% endif %}>{{ name }} ({{ code|upper }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="file" class="form-label" style="font-weight:600;font-size:0.85rem;">엑셀 파일 선택</label>
                        <input type="file" class="form-control" id="file" accept=".xlsx,.xls,.csv">
                        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;">지원 형식: .xlsx, .csv &middot; 최대 10MB<br>CSV 파일은 자동으로 RAW 데이터로 임포트됩니다</div>
                    </div>
                    <button type="button" id="uploadBtn" class="btn btn-primary w-100" style="padding:0.75rem;" onclick="doUpload()">
                        <i class="bi bi-cloud-arrow-up-fill"></i> 업로드 및 임포트
                    </button>
                </div>

                <!-- 업로드 진행 중 -->
                <div id="upload-progress" style="display:none;text-align:center;padding:2rem 0;">
                    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p id="progress-text" style="margin-top:1rem;color:var(--text-secondary);font-size:0.9rem;">
                        파일 업로드 및 임포트 중...
                    </p>
                    <p style="color:var(--text-muted);font-size:0.75rem;">페이지를 닫지 마세요. 잠시만 기다려주세요.</p>
                </div>

                <!-- 지역별 파일 요구사항 안내 -->
                <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border-color);">
                    <h6 style="font-size:0.85rem;font-weight:700;margin-bottom:0.75rem;">
                        <i class="bi bi-info-circle" style="color:var(--accent-blue);"></i> 파일 요구사항
                    </h6>

                    <!-- US Guide -->
                    <div id="guide-us" class="region-guide">
                        <ul style="color:var(--text-muted);font-size:0.8rem;padding-left:1.2rem;margin:0;line-height:1.8;">
                            <li>시트명: <code style="color:var(--accent-blue);background:rgba(99,102,241,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">손익관리_1월</code> ~ <code style="color:var(--accent-blue);background:rgba(99,102,241,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">손익관리_12월</code></li>
                            <li>브랜드: <code style="color:var(--accent-purple);background:rgba(139,92,246,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">닥터블릿 매출_1월</code>, <code style="color:var(--accent-purple);background:rgba(139,92,246,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">Calo 매출_1월</code></li>
                            <li>RAW: <code style="color:var(--accent-amber);background:rgba(245,158,11,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">쇼피파이 매출_RAW</code>, <code style="color:var(--accent-amber);background:rgba(245,158,11,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">틱톡샵 매출_RAW</code></li>
                            <li>세금: <code style="color:var(--accent-green);background:rgba(34,197,94,0.1);padding:0.1rem 0.3rem;border-radius:4px;font-size:0.75rem;">Tax_TT</code></li>
                        </ul>
                    </div>

                    <!-- CN Guide -->
                    <div id="guide-cn" class="region-guide" style="display:none;">
                        <ul style="color:var(--text-muted);font-size:0.8rem;padding-left:1.2rem;margin:0;line-height:1.8;">
                            <li>시트명: <code style="font-size:0.75rem;">손익관리_1월</code> ~ <code style="font-size:0.75rem;">손익관리_12월</code></li>
                            <li>브랜드: <code style="font-size:0.75rem;">닥터블릿 매출_1월</code>, <code style="font-size:0.75rem;">EOA 매출_1월</code>, <code style="font-size:0.75rem;">낫띵베럴 매출_1월</code>, <code style="font-size:0.75rem;">테트라큐어 매출_1월</code></li>
                            <li>RAW: <code style="font-size:0.75rem;">쇼피 매출_RAW</code></li>
                        </ul>
                    </div>

                    <!-- JP Guide -->
                    <div id="guide-jp" class="region-guide" style="display:none;">
                        <ul style="color:var(--text-muted);font-size:0.8rem;padding-left:1.2rem;margin:0;line-height:1.8;">
                            <li>시트명: <code style="font-size:0.75rem;">손익관리_1월</code> ~ <code style="font-size:0.75rem;">손익관리_12월</code></li>
                            <li>브랜드: <code style="font-size:0.75rem;">닥터블릿 매출_1월</code>, <code style="font-size:0.75rem;">낫띵베럴 매출_1월</code></li>
                            <li>RAW: <code style="font-size:0.75rem;">큐텐 매출_RAW</code></li>
                        </ul>
                    </div>

                    <!-- Global Guide -->
                    <div id="guide-global" class="region-guide" style="display:none;">
                        <ul style="color:var(--text-muted);font-size:0.8rem;padding-left:1.2rem;margin:0;line-height:1.8;">
                            <li>시트명: <code style="font-size:0.75rem;">손익관리 전체_1월</code> ~ <code style="font-size:0.75rem;">손익관리 전체_12월</code></li>
                            <li>추가: <code style="font-size:0.75rem;">월별 매출</code>, <code style="font-size:0.75rem;">ROAS</code>, <code style="font-size:0.75rem;">B2B/건기식</code></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateGuide(region) {
    document.querySelectorAll('.region-guide').forEach(el => el.style.display = 'none');
    const guide = document.getElementById('guide-' + region);
    if (guide) guide.style.display = 'block';
}
updateGuide(document.getElementById('region').value);

function showResult(ok, msg) {
    const area = document.getElementById('result-area');
    const cls = ok ? 'alert-success' : 'alert-danger';
    const icon = ok ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
    area.innerHTML = '<div class="alert ' + cls + ' d-flex align-items-center" style="font-size:0.85rem;">' +
        '<i class="bi ' + icon + '" style="margin-right:0.5rem;"></i>' +
        '<div>' + msg + '</div></div>';
    area.style.display = 'block';
    area.scrollIntoView({behavior: 'smooth', block: 'start'});
}

function doUpload() {
    const fileInput = document.getElementById('file');
    const file = fileInput.files[0];
    if (!file) {
        showResult(false, '파일을 선택해주세요.');
        return;
    }
    if (file.size > 10 * 1024 * 1024) {
        showResult(false, '파일이 너무 큽니다 (' + Math.round(file.size/1024/1024) + 'MB). 최대 10MB');
        return;
    }

    document.getElementById('upload-form').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('progress-text').textContent = '"' + file.name + '" 업로드 및 임포트 중...';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('region', document.getElementById('region').value);

    fetch('/api/upload-excel/', {
        method: 'POST',
        body: formData,
    })
    .then(function(resp) { return resp.json(); })
    .then(function(data) {
        document.getElementById('upload-progress').style.display = 'none';
        document.getElementById('upload-form').style.display = 'block';
        if (data.ok) {
            showResult(true, data.message || '임포트 완료!');
        } else {
            showResult(false, data.error || '알 수 없는 오류');
        }
        fileInput.value = '';
    })
    .catch(function(err) {
        document.getElementById('upload-progress').style.display = 'none';
        document.getElementById('upload-form').style.display = 'block';
        showResult(false, '서버 연결 실패: ' + err.message);
        fileInput.value = '';
    });
}
</script>
{% endblock %}
